#!/usr/bin/execlineb -P
# -*- mode: bash -*-
# vi: set ft=bash:

foreground { s6-echo " [run] goss jhbuild tests" }

# FIXME: This is broken for some reason
# exec s6-setuidgid pi /bin/bash -C '/usr/local/bin/goss -g /tests/goss.jhbuild.yaml validate --retry-timeout 30s --sleep 1s'

# FIXME: This is broken as well
# exec s6-setuidgid pi /bin/bash -C '/usr/local/bin/goss --help'

# FIXME: Wow so this is busted too, error below
# exec s6-setuidgid pi /bin/bash -C 'w'


# jhbuild_pygobject3_1  |  [run] SCARLETT_BUILD_GNOME not set, moving on ...
# jhbuild_pygobject3_1  | [cont-init.d] 40-init-jhbuild: exited 0.
# jhbuild_pygobject3_1  | [cont-init.d] 50-init-dgoss: executing...
# jhbuild_pygobject3_1  | [run] goss jhbuild tests
# jhbuild_pygobject3_1  | /usr/bin/who: /usr/bin/who: cannot execute binary file
# jhbuild_pygobject3_1  | [cont-init.d] 50-init-dgoss: exited 126.
# jhbuild_pygobject3_1  | [cont-finish.d] executing container finish scripts...
# jhbuild_pygobject3_1  | [cont-finish.d] done.

# NOTE: Lets try this with execlineb, meaning it'll run as root
# TODO: Surround this in a conditional to tell us to run the tests or skip them. By default we want them on
# NOTE: Okay this actually runs, BUT, it errors on 30 items because it isn't running as pi user

# s6-setuidgid pi
# with-contenv
# s6-env -i
# /usr/local/bin/goss -g /tests/goss.jhbuild.yaml validate --retry-timeout 30s --sleep 1s

# Okay I think this will actually run the tests like the pi user
# su - pi -c "/usr/local/bin/goss -g /tests/goss.jhbuild.yaml validate --retry-timeout 30s --sleep 1s"

with-contenv
s6-envuidgid pi
multisubstitute
{
  import -u -D0 UID
  import -u -D0 GID
  import -u -D0 DEBIAN_FRONTEND
  import -u -D0 LANG
  import -u -D0 LC_ALL
  import -u -D0 UNAME
  import -u -D0 NOT_ROOT_USER
  import -u -D0 USER_HOME
  import -u -D0 PROJECT_HOME
  import -u -D0 SKIP_ON_TRAVIS
  import -u -D0 CURRENT_DIR
  import -u -D0 GSTREAMER
  import -u -D0 ENABLE_PYTHON3
  import -u -D0 ENABLE_GTK
  import -u -D0 PREFIX
  import -u -D0 JHBUILD
  import -u -D0 PATH
  import -u -D0 LD_LIBRARY_PATH
  import -u -D0 PYTHONPATH
  import -u -D0 PKG_CONFIG_PATH
  import -u -D0 XDG_DATA_DIRS
  import -u -D0 XDG_CONFIG_DIRS
  import -u -D0 PYTHON
  import -u -D0 NOTVISIBLE
  import -u -D0 VIRTUALENVWRAPPER_VIRTUALENV
  import -u -D0 VIRTUALENV_WRAPPER_SH
  import -u -D0 PYTHONUNBUFFERED
  import -u -D0 PYTHON_VERSION_MAJOR
  import -u -D0 USER
  import -u -D0 LANGUAGE_ID
  import -u -D0 GITHUB_BRANCH
  import -u -D0 GITHUB_REPO_NAME
  import -u -D0 GITHUB_REPO_ORG
  import -u -D0 PI_HOME
  import -u -D0 MAIN_DIR
  import -u -D0 VIRT_ROOT
  import -u -D0 SCARLETT_CONFIG
  import -u -D0 SCARLETT_HMM
  import -u -D0 SCARLETT_LM
  import -u -D0 SCARLETT_DICT
  import -u -D0 GST_PLUGIN_PATH
  import -u -D0 PYTHON_VERSION
  import -u -D0 VIRTUALENVWRAPPER_PYTHON
  import -u -D0 VIRTUALENVWRAPPER_SCRIPT
  import -u -D0 PYTHONSTARTUP
  import -u -D0 PIP_DOWNLOAD_CACHE
  import -u -D0 WORKON_HOME
  import -u -D0 USER_SSH_PUBKEY
  import -u -D0 HOME
}
/usr/local/bin/goss -g /tests/goss.jhbuild.yaml validate --retry-timeout 30s --sleep 1s

# /bin/bash -C "/usr/local/bin/goss -g /tests/goss.jhbuild.yaml validate --retry-timeout 30s --sleep 1s"

######################################################################
# source: claw-docker-base
# NOTE: This will overwrite new environment variables you set
# in here using multiline to the ones the container sees!
# multisubstitute
# {
#   import -D "etcd" ETCD_HOST
#   import -D "2379" ETCD_HOST_PORT
#   import -D 0 ETCD_CONNECTION_TIMEOUT
# }
# foreground {
#   with-contenv
#   s6-env -i
#   s6-dumpenv -- /var/run/s6/container_environment
# }
######################################################################

## Signal build complete if running on ci ##
# if [[ $TRAVIS_CI ]]; then
#   echo " [run] finished running jhbuild goss tests ... sending signal complete"
#   exit $SIGNAL_BUILD_STOP
# fi

# importas program
# source: https://skarnet.org/software/execline/importas.html

foreground { s6-echo " [ [run] finished running jhbuild goss tests ... sending signal complete" }
exit $SIGNAL_BUILD_STOP
